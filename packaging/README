How to build a Windows Installer for Sound Studio
*************************************************

Copyright (C) 2013 Andrew Makousky
All rights reserved.
See the end of this file for license conditions.

Sound Studio supports building a Windows Installer through two
different mechanisms.  You can either build a Windows installer using
Nullsoft Scriptable Install System or by using Windows Installer.
This file mainly documents the prerequisites that you must satisfy to
build a Windows installer.  The Nullsoft Installer build process is
fully automatic once you satisfy the prerequisites; on the other hand,
the Windows Installer build process is only mostly automatic.

General Prerequisites
*********************

Sound Studio depends on the GTK+ runtime binaries for Windows.  If you
have not done so already, you should download the GTK+ 2.12.10 bundle
for Windows that was recommended in the INSTALL file.  If you want to
build an installer using Nullsoft Scriptable Install System, then you
will need to download the corresponding development tools
<http://nsis.sourceforge.net>.  If you want to build a Windows MSI
Installer package, you will need the Windows Platform SDK.  Once you
have one or both of those, you will need to select a subset of the
files from the bundle for distribution.  There is a a file named
`2.12.10-dist.txt' that lists the recommended files for distributing
with Sound Studio.  You should use this file to build a directory
named `2.12.10-dist' within the `packaging' directory.  For example:

  cd ${top_srcdir}/packaging
  ln -s /.../gtk+-bundle-2.12.10.zip .
  make 2.12.10-dist

Make sure you have your build configuration set up to compile release
binaries.  In particular, if you are using MinGW/MSYS, you should pass
the switch

  CFLAGS='-Wl,-subsystem=windows'

to the `configure' script, just as was recommended in the file
`INSTALL'.

Building a Nullsoft Installer
*****************************

Building a Nullsoft Installer is easy.  Just make sure you have
enabled maintainer mode like this:

  ./configure --enable-maintainer-mode

and the installer will be built fully automatically, provided that you
have set up the GTK+ dependencies directory.  If you are not in
maintainer mode, you can make the Nullsoft Installer with the
following command:

  make nsis

Building a Windows MSI Installer Package
****************************************

Most Free Software and open-source software projects either use
Nullsoft Install System or Inno Setup to install binaries on Microsoft
Windows operating systems.  However, if you are strange enough to not
only want to use a Windows Installer, but also use Microsoft Visual
Studio to compile your projects, then there are several difficult
hoops that you are forcing yourself to jump through in order to get
distributable binaries.  You have been warned.

First of all, Nullsoft Install System and Inno Setup are
compiler-based, which means you, as a setup developer, can benefit
from the many automated processes that they provide, without being
aware that there are worse ways to build an installer.  However,
Windows Installer files are principally specified as a database of
tables that may also have binary data attached to them.  Microsoft's
Platform SDK will provide you with programs to work with this
database, but it is your responsibility to either obtain third-party
software that will facilitate automated Windows Installer creation
processes or make your own in-house automation tools.

The worst part of creating a Windows Installer without automation
tools is specifying all of the files that must be installed and how
they are related to "Features."  For this, I created my own automation
application called `msi-tool'.  `msi-tool' was not originally intended
to be an automated installer build system.  Rather, it was intended to
only automate the most difficult tasks for creating a Windows
Installer.  Thus, some manual setup is needed before you can use it.
Once you have the manual setup done, you will be able to use the
integrated rules for `msi-tool' that are within Sound Studio's build
system.

First of all, you have to have prerequisites satisfied.  First make
sure you have installed the Windows Platform SDK.  After you have that
done, you will also need to manually install some tools that you will
use to work with Windows Installers.  First locate the installation
directory for the Windows Platform SDK.  Navigate to the `Bin'
subdirectory.  There will be two Windows Installer packages of
interest within that directory: `Orca.Msi' and `MsiVal2.Msi'.  Install
both of them.  To be able to use the automated build rules, you need
to make sure your PATH environment variable is set up to be able to
use both the Windows Platform SDK tools and POSIX utilities.  If you
are using MSYS or Cygwin for your POSIX utilities, then you will have
to make sure that you are not building Sound Studio's Windows
Installer package in any subdirectory within the root directories that
MSYS and Cygwin use.  Otherwise, there will be problems passing the
current working directory to the Windows developer tools that the
build automation rules invoke.

Next you will do the manual setup for Sound Studio.  Start by copying
the UI sample MSI from the Windows Platform SDK installation, located
at the subdirectory `Samples\SysMgmt\Msi\database\UISample.Msi'.  Put
the copy in the Sound Studio's `packaging/' directory and rename it to
`Schema.msi'.  Next, open `Schema.msi' with Orca and make the
following changes:

  * In the "Control" table, select the table row that contains
    "VerifyRemoveDlg" in the "Dialog" column and "Title" in the
    "Control" column.  Scroll right until you see the "Text" column
    within that row.  Now change its value to
    "{\DlgFontBold8}Remove [ProductName]".

  * In the "Control" table, find the table row that contains
    "LicenseAgreementDlg" in the "Dialog" column and "AgreementText"
    in the "Control" column.  Scroll right until you see the "Text"
    column within that row.  Now copy the contents of `license.rtf'
    into that row.

  * In the "Binary" table, locate the row with "bannerbmp" under the
    "Name" column and change its value to the data of `bannerbmp.bmp'.

Now you should be all ready to run the automated build rules.  Just
type:

  make msi

and a Windows Installer package will be automatically built and
validated.  Note that the Windows Installer automatic build system
within Sound Studio is slightly less stable than the build system for
Nullsoft Installer.  The build rules are largely based off of the
documentation for `msi-tool', so if anything fails, read that
documentation carefully for more information.  Note that the automated
build process isn't perfect.  You will probably want to add some long
descriptions to the features in the "Feature" table, but strictly
speaking, you don't have to, and if you don't, you will still get a
working installer.

If you compile with MSVC, you will have to manually put the
MSVC-compiled binary within the installer preparation directory named
`_nsis'.  When you compile with MSVC, make sure you compile a Release
binary.  The release configuration is set up so that Sound Studio will
be static-linked to the Microsoft C Runtime libraries by default.
Here are a few reasons why.  If you choose the shared C Runtime, you
will need to make sure the target computer has the runtime libraries.
There are two ways to satisfy this need.  You can either install the
runtime libraries system-wide or you can include them with your
application's installation to form an isolated assembly.  However,
including the dynamic-linked Microsoft C Runtime libraries with your
application's installer has drawbacks you you are licensing your
application under the GNU General Public License.  Specifically, you
must package and distribute your application such that the
dynamic-linked Microsoft C Runtime libraries are System Libraries, and
thus you do not need to include the source code for them.  They can
only be considered system libraries if you do not distribute them with
your application.  Under my interpretation, if you instead static link
the runtime libraries, then they are still considered System
Libraries.  In this case, the System Libraries were linked as part of
using the Windows development tools to create your application, and
thus the source code need not be distributed since the "Corresponding
Source" does not include the source code for generally available
tools, such as the Windows development tools.  See
<http://www.gnu.org/licenses/gpl-faq#WindowsRuntimeAndGPL> for some
explanation on the subject, and see the GNU General Public License for
the official terms and conditions.

License Condtions
*****************

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

  * Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

  * Redistributions in binary form must reproduce the above copyright
    notice, this list of conditions and the following disclaimer in
    the documentation and/or other materials provided with the
    distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
